<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Person Detection â€” Dashboard</title>

<style>
body{font-family:Arial, Helvetica, sans-serif;background:#f4f6f8;margin:0;padding:24px}
.container{max-width:1100px;margin:0 auto}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
h1{font-size:20px;margin:0}
.header-right{display:flex;align-items:center;gap:10px}
#videoWrap{background:#000;border-radius:8px;overflow:hidden;height:540px;display:flex;justify-content:center;align-items:center;position:relative}
/* New style for fullscreen mode */
#videoWrap:fullscreen {
    height: 100vh; /* Use full viewport height */
    width: 100vw;  /* Use full viewport width */
    max-width: none; /* Override max-width */
    border-radius: 0;
}
#stream{width:100%;height:100%;object-fit:cover}
#overlay{position:absolute;left:0;top:0;pointer-events:none}
.controls{display:flex;gap:12px;margin-top:10px}
.countBox{background:#fff;padding:12px;border-radius:8px}
.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:#1f6feb;color:#fff}
.btn.logout{background:#e53e3e}
/* New style for the fullscreen button to match others */
.btn.fullscreen{background:#5cb85c} 
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45)}
.modal.show{display:flex}
.modal-card{background:#fff;padding:20px;border-radius:8px;max-width:420px;text-align:center}
.people-table{margin-top:10px;background:#fff;padding:10px;border-radius:8px;font-size:13px}
.people-table table{width:100%;border-collapse:collapse}
.people-table th,.people-table td{padding:6px 8px;border-bottom:1px solid #eee}
.anomaly-flag{color:#e53e3e;font-weight:bold}
</style>
</head>

<body>
<div class="container">
<header>
<h1>Person Detection Dashboard</h1>
<div class="header-right">
Â  Â  <a href="/history" style="text-decoration: none;">
Â  Â  Â  Â  <button class="btn" style="background: #333; margin-right: 10px;">History</button>
Â  Â  </a>
    <button id="fullscreenBtn" class="btn fullscreen">Full Screen</button>
Â  Â  <a href="/logout"><button class="btn logout">Logout</button></a>
</div>
</header>

<div id="videoWrap">
<img id="stream" src="/video">
<canvas id="overlay"></canvas>
</div>

<div class="controls">
<div class="countBox">Persons: <strong id="count">0</strong></div>
<div class="countBox" id="conflictBox" style="display:none;color:#e53e3e">
âš  Crowd Conflict Detected
</div>
</div>

<div class="people-table" id="peopleTable" style="display:none">
<table>
<thead>
<tr><th>ID</th><th>Speed</th><th>Direction</th><th>Anomaly</th></tr>
</thead>
<tbody id="peopleBody"></tbody>
</table>
</div>
</div>

<div id="alertModal" class="modal">
<div class="modal-card">
<h2>âš  Alert</h2>
<p id="alertMessage"></p>
<button id="dismissBtn" class="btn">Dismiss</button>
</div>
</div>

<audio id="alertSound">
<source src="/static/snd/alert.mp3" type="audio/mpeg">
</audio>

<script>
const POLL_MS = 500;
const LOITER_CONFIRM_MS = 8000; Â  // ðŸ”¥ must persist 8s
const ALERT_COOLDOWN_MS = 20000;

const anomalyTimers = {};
let lastGlobalAlert = 0;

const countEl = document.getElementById('count');
const peopleBody = document.getElementById('peopleBody');
const peopleTable = document.getElementById('peopleTable');
const conflictBox = document.getElementById('conflictBox');
const alertModal = document.getElementById('alertModal');
const alertMessage = document.getElementById('alertMessage');
// Get new elements
const videoWrap = document.getElementById('videoWrap');
const fullscreenBtn = document.getElementById('fullscreenBtn');

async function poll(){
Â  try{
Â  Â  const res = await fetch('/count',{cache:'no-store'});
Â  Â  const data = await res.json();

Â  Â  countEl.textContent = data.persons ?? 0;
Â  Â  conflictBox.style.display = data.crowd_conflict ? 'block' : 'none';

Â  Â  peopleBody.innerHTML='';
Â  Â  if(Array.isArray(data.people) && data.people.length){
Â  Â  Â  peopleTable.style.display='block';

Â  Â  Â  data.people.forEach(p=>{
Â  Â  Â  Â  const tr=document.createElement('tr');
Â  Â  Â  Â  tr.innerHTML=`
Â  Â  Â  Â  Â  <td>${p.id}</td>
Â  Â  Â  Â  Â  <td>${p.speed_px_s}</td>
Â  Â  Â  Â  Â  <td>${p.direction}</td>
Â  Â  Â  Â  Â  <td>${p.anomaly ? '<span class="anomaly-flag">'+p.anomaly_reason+'</span>' : 'No'}</td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  peopleBody.appendChild(tr);

Â  Â  Â  Â  // ðŸ”¥ LOITER CONFIRMATION (FIX)
Â  Â  Â  Â  if(p.anomaly && p.anomaly_reason === 'LOITERING'){
Â  Â  Â  Â  Â  if(!anomalyTimers[p.id]) anomalyTimers[p.id]=Date.now();
Â  Â  Â  Â  Â  const held = Date.now() - anomalyTimers[p.id];

Â  Â  Â  Â  Â  if(held > LOITER_CONFIRM_MS){
Â  Â  Â  Â  Â  Â  triggerAlert(`Loitering detected (ID ${p.id})`);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  delete anomalyTimers[p.id];
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  peopleTable.style.display='none';
Â  Â  }

Â  Â  if(data.crowd_conflict){
Â  Â  Â  triggerAlert('Crowd conflict detected!');
Â  Â  }
Â  }catch(e){console.error(e);}
}

function triggerAlert(msg){
Â  const now = Date.now();
Â  if(now - lastGlobalAlert < ALERT_COOLDOWN_MS) return;

Â  lastGlobalAlert = now;
Â  alertMessage.textContent = msg;
Â  alertModal.classList.add('show');
Â  document.getElementById('alertSound')?.play().catch(()=>{});
}

document.getElementById('dismissBtn').onclick=()=>{
Â  alertModal.classList.remove('show');
};

// --- NEW FULLSCREEN FUNCTIONALITY ---

function toggleFullscreen() {
    if (document.fullscreenElement) {
        // Exit fullscreen
        document.exitFullscreen().catch(err => {
            console.error(`Error attempting to exit fullscreen mode: ${err.message}`);
        });
    } else {
        // Enter fullscreen on the videoWrap element
        videoWrap.requestFullscreen().catch(err => {
            console.error(`Error attempting to enable fullscreen mode: ${err.message}`);
        });
    }
}

// Event listener for the new button
fullscreenBtn.addEventListener('click', toggleFullscreen);

// Update button text when fullscreen state changes
document.addEventListener('fullscreenchange', () => {
    if (document.fullscreenElement) {
        fullscreenBtn.textContent = 'Exit Full Screen';
    } else {
        fullscreenBtn.textContent = 'Full Screen';
    }
});

// --- END NEW FULLSCREEN FUNCTIONALITY ---

setInterval(poll, POLL_MS);
</script>
</body>
</html>